"use strict";
/**
 * instrument mongoose to record/replay queries ( !! only queries so far)
 *
 * allows to run (mongoose read only) unit tests w.o. a mongoose instance
 *
 * @file
 */
Object.defineProperty(exports, "__esModule", { value: true });
exports.mongooseMock = exports.instrumentMongoose = exports.instrumentModelReplay = exports.instrumentModelRecord = exports.retrieveOp = exports.recordOp = exports.digestArgs = exports.instrumentModel = exports.JSONStringify = exports.JSONParse = void 0;
const debugf = require("debugf");
var debuglog = debugf('mongoose_record_replay');
//const loadlog = logger.logger('modelload', '');
const path = require('path');
const process = require("process");
const mongoose = require("mongoose");
const events = require("events");
const fs = require("fs");
const crypto = require('crypto');
/**
 * The recording path, set via argument
 * or
 */
var recordingPath = 'mongoose_record_replay/';
var theMode = undefined;
function JSONParse(text) {
    function customDeSer(key, value) {
        if (value.toString().indexOf("__REGEXP ") == 0) {
            var m = value.split("__REGEXP ")[1].match(/\/(.*)\/(.*)?/);
            return new RegExp(m[1], m[2] || "");
        }
        else
            return value;
    }
    return JSON.parse(text, customDeSer);
}
exports.JSONParse = JSONParse;
function JSONStringify(obj) {
    function customSer(key, value) {
        if (value instanceof RegExp) {
            return ("__REGEXP " + value.toString());
        }
        else
            return value;
    }
    return JSON.stringify(obj, customSer, 2);
}
exports.JSONStringify = JSONStringify;
function readFileAsJSON(filename) {
    var data = fs.readFileSync(filename, 'utf-8');
    try {
        return JSON.parse(data);
    }
    catch (e) {
        console.log("Content of file " + filename + " is no json" + e);
        process.exit(-1);
    }
    return undefined;
}
function assurePath(path) {
    try {
        fs.mkdirSync(path);
    }
    catch (e) {
    }
    try {
        fs.mkdirSync(path + 'data');
    }
    catch (e) {
    }
}
var dbEmitter = new events.EventEmitter();
// unit test invoke this multiple times, avoid node js warning
dbEmitter.setMaxListeners(0);
function instrumentModel(model) {
    if (theMode === "RECORD") {
        instrumentModelRecord(model);
    }
    else if (theMode === "REPLAY") {
        // todo
        instrumentModelReplay(model);
    }
    return model;
}
exports.instrumentModel = instrumentModel;
function makeFileName(digest) {
    return (recordingPath + 'data/' + digest + '.json');
}
function digestArgs(op, name, query) {
    var md5sum = crypto.createHash('md5');
    debuglog('here the name ' + name);
    md5sum.update(op + name + JSONStringify(query));
    var digest = '' + md5sum.digest('hex');
    return digest;
}
exports.digestArgs = digestArgs;
function recordOp(op, name, query, res) {
    var digest = digestArgs(op, name, query);
    var resStr = JSON.stringify(res, undefined, 2);
    var len = 0;
    if (res && Array.isArray(res)) {
        len = res.length;
    }
    else {
        len = resStr.length;
    }
    var filename = makeFileName(digest);
    console.log('recording to file: ' + filename + ' (' + path.normalize(filename) + ')...');
    fs.writeFileSync(filename, resStr);
    var known = {};
    try {
        known = readFileAsJSON(recordingPath + 'queries.json');
    }
    catch (ex) {
    }
    known[digest] = {
        op: op,
        name: name,
        digest: digest,
        query: query,
        res: len
    };
    fs.writeFileSync(recordingPath + 'queries.json', JSONStringify(known));
}
exports.recordOp = recordOp;
function retrieveOp(op, name, query) {
    var digest = digestArgs(op, name, query);
    var filename = makeFileName(digest);
    debuglog(' reading from filename ' + filename);
    try {
        var res = readFileAsJSON(filename);
    }
    catch (e) {
        console.log(e);
        console.log(e.stack);
        console.log(`did not find query result recording (${filename}) \n for collection ${name} operation ${op} \n query arguments: ` + JSONStringify(query));
        throw e;
    }
    if (res === undefined) {
        debuglog('empty result for query ' + op + ' ' + JSON.stringify(query, undefined, 2) + '\n' + filename);
    }
    return res;
}
exports.retrieveOp = retrieveOp;
function instrumentModelRecord(modelDoc) {
    console.log('mongoose_record_replay is instrumenting model ' + modelDoc.modelName + ' for recording to ' + recordingPath);
    var oFind = modelDoc.find;
    modelDoc.find = function () {
        debuglog('someone is calling find with ' + modelDoc.modelName + JSON.stringify(arguments, undefined, 2));
        var res = oFind.apply(modelDoc, arguments);
        if (arguments.length !== 1) {
            throw Error('expected one argument in find, was ' + arguments.length);
        }
        var query = arguments[0];
        res.lean().exec().then((a) => {
            //console.log("here result1 + " + JSON.stringify(a, undefined,2) );
            recordOp("find", modelDoc.modelName, query, a);
        });
        return res;
    };
    var oDistinct = modelDoc.distinct;
    modelDoc.distinct = function () {
        debuglog('someone is calling distinct with' + JSON.stringify(arguments, undefined, 2));
        var res = oDistinct.apply(modelDoc, arguments);
        if (arguments.length !== 1) {
            throw Error('expected one argument ' + JSON.stringify(arguments));
        }
        var query = arguments[0];
        var res2 = res.then((a) => {
            debuglog(() => "here result1 + " + JSON.stringify(a, undefined, 2));
            try {
                recordOp("distinct", modelDoc.modelName, query, a);
            }
            catch (ex) {
                console.log(' recording to file failed ' + ex);
                debuglog(() => " recording to file failed " + ex);
                throw ex;
            }
            return a;
        });
        return res; //res2.then((b) => { console.log(' 2nd promise then ' + b && b.length); return b; });
    };
    var oAggregate = modelDoc.aggregate;
    modelDoc.aggregate = function () {
        debuglog(() => 'someone is calling aggregate with' + JSON.stringify(arguments, undefined, 2));
        var query = Array.prototype.slice.call(arguments);
        var res = oAggregate.apply(modelDoc, arguments);
        res.then((a) => {
            debuglog(() => "here result1 + " + JSON.stringify(a, undefined, 2));
            recordOp("aggregate", modelDoc.modelName, query, a);
        });
        return res;
    };
}
exports.instrumentModelRecord = instrumentModelRecord;
function instrumentModelReplay(modelDoc) {
    console.log('instrumenting model ' + modelDoc.modelName + ' for replay from path ' + recordingPath);
    debuglog('instrumenting model ' + modelDoc.modelName);
    var oFind = modelDoc.find;
    modelDoc.find = function () {
        debuglog(() => 'someone is replaying find with' + JSON.stringify(arguments, undefined, 2));
        var query = arguments[0];
        var res = retrieveOp("find", modelDoc.modelName, query);
        debuglog(() => 'returning res ' + JSON.stringify(res) + ' for query find' + query);
        return {
            lean: function () {
                return {
                    exec: function () {
                        return new Promise(function (resolve, reject) {
                            setTimeout(function () {
                                resolve(res);
                            }, 0);
                        });
                    }
                };
            }
        };
    };
    var oDistinct = modelDoc.distinct;
    modelDoc.distinct = function () {
        debuglog('someone is replaying distinct with' + JSON.stringify(arguments, undefined, 2));
        var query = arguments[0];
        var res = retrieveOp("distinct", modelDoc.modelName, query);
        debuglog('returning res ' + JSON.stringify(res) + ' for query find' + query);
        return new Promise(function (resolve, reject) {
            setTimeout(function () { resolve(res); }, 0);
        });
    };
    var oAggregate = modelDoc.aggregate;
    modelDoc.aggregate = function () {
        debuglog('someone is replaying aggregate with' + JSON.stringify(arguments, undefined, 2));
        var query = Array.prototype.slice.call(arguments);
        var res = retrieveOp("aggregate", modelDoc.modelName, query);
        var p = new Promise(function (resolve, reject) {
            setTimeout(function () { resolve(res); }, 0);
        });
        p.exec = function () {
            return p;
        };
        return p;
    };
}
exports.instrumentModelReplay = instrumentModelReplay;
/**
 * funtion to instrument mongoose
 *
 *
 *
 * @param mongoose a real mongoose instance
 * @param [path] {string} optional, a path to write/read files from, defaults to "mgrecrep/"
 * @param mode {string}  undefined (environment value) or "REPLAY" or "RECORD"
 */
function instrumentMongoose(mongoose, path, mode) {
    theMode = mode || process.env.MONGO_RECORD_REPLAY;
    if (theMode && ["REPLAY", "RECORD"].indexOf(mode) < 0) {
        console.log('passed mode value or env MONGO_RECORD_REPLAY may only be "RECORD" or "REPLAY" , MONGO_RECORD MONGO_REPLAY');
        throw new Error('mongoose_record_replay mode should be one of "REPLAY", "RECORD"  was ' + theMode);
    }
    if (theMode === "RECORD") {
        recordingPath = path || process.env.MONGO_RECORD_REPLAY_PATH || "mongoose_record_replay";
        console.log('!* mode RECORD to path ' + recordingPath);
        assurePath(recordingPath);
        var omodel = mongoose.model;
        mongoose.model = function () {
            if (arguments.length > 1) {
                return instrumentModel(omodel.apply(mongoose, arguments));
            }
            return omodel.apply(mongoose, arguments);
        };
        return mongoose;
    }
    else if (theMode === "REPLAY") {
        console.log('!* mode REPLAY from path ' + recordingPath);
        recordingPath = path || process.env.MONGO_RECORD_REPLAY_PATH || "mongoose_record_replay";
        return exports.mongooseMock;
    }
    return mongoose;
}
exports.instrumentMongoose = instrumentMongoose;
exports.mongooseMock = {
    models: {},
    modelNames: function () {
        return Object.keys(this.models);
    },
    Schema: mongoose.Schema,
    model: function (a, b) {
        if (b === undefined) {
            return this.models[a];
        }
        debuglog('creating model  ' + a + ' at mock');
        this.models[a] = instrumentModel({
            find: function () { },
            aggregate: function () { },
            distinct: function () { },
            modelName: a,
            schema: b,
        });
        return this.models[a];
    },
    disconnect: function () {
        debuglog('simulationg disconnect ');
    },
    connect: function (connStr) {
        // this.db.on.emit('on');
        debuglog('simulationg connecting to ' + connStr);
        if (!this._once) {
            var that = this;
            setTimeout(function () {
                that.connection.emit('open');
                debuglog('fired emit');
            }, 0);
        }
    },
    connection: dbEmitter
};

//# sourceMappingURL=data:application/json;charset=utf8;base64,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QUNiLElBQUksSUFBSSxHQUFHLElBQUksQ0FBQztZQUNoQixVQUFVLENBQUM7Z0JBQ1AsSUFBSSxDQUFDLFVBQVUsQ0FBQyxJQUFJLENBQUMsTUFBTSxDQUFDLENBQUM7Z0JBQzdCLFFBQVEsQ0FBQyxZQUFZLENBQUMsQ0FBQztZQUMzQixDQUFDLEVBQUUsQ0FBQyxDQUFDLENBQUM7U0FDVDtJQUNMLENBQUM7SUFDRCxVQUFVLEVBQUUsU0FBUztDQUN4QixDQUFDIiwiZmlsZSI6Im1ncmVjcmVwLmpzIiwic291cmNlc0NvbnRlbnQiOlsiLyoqXHJcbiAqIGluc3RydW1lbnQgbW9uZ29vc2UgdG8gcmVjb3JkL3JlcGxheSBxdWVyaWVzICggISEgb25seSBxdWVyaWVzIHNvIGZhcilcclxuICpcclxuICogYWxsb3dzIHRvIHJ1biAobW9uZ29vc2UgcmVhZCBvbmx5KSB1bml0IHRlc3RzIHcuby4gYSBtb25nb29zZSBpbnN0YW5jZVxyXG4gKlxyXG4gKiBAZmlsZVxyXG4gKi9cclxuXHJcbmltcG9ydCAqIGFzIGRlYnVnZiBmcm9tICdkZWJ1Z2YnO1xyXG5cclxudmFyIGRlYnVnbG9nID0gZGVidWdmKCdtb25nb29zZV9yZWNvcmRfcmVwbGF5Jyk7XHJcbi8vY29uc3QgbG9hZGxvZyA9IGxvZ2dlci5sb2dnZXIoJ21vZGVsbG9hZCcsICcnKTtcclxuXHJcbmNvbnN0IHBhdGggPSByZXF1aXJlKCdwYXRoJyk7XHJcbmltcG9ydCAqIGFzIHByb2Nlc3MgZnJvbSAncHJvY2Vzcyc7XHJcbmltcG9ydCAqIGFzIG1vbmdvb3NlIGZyb20gJ21vbmdvb3NlJztcclxuaW1wb3J0ICogYXMgZXZlbnRzIGZyb20gJ2V2ZW50cyc7XHJcbmltcG9ydCAqIGFzIGZzIGZyb20gJ2ZzJztcclxuY29uc3QgY3J5cHRvID0gcmVxdWlyZSgnY3J5cHRvJyk7XHJcblxyXG5cclxuLyoqXHJcbiAqIFRoZSByZWNvcmRpbmcgcGF0aCwgc2V0IHZpYSBhcmd1bWVudFxyXG4gKiBvclxyXG4gKi9cclxudmFyIHJlY29yZGluZ1BhdGggPSAnbW9uZ29vc2VfcmVjb3JkX3JlcGxheS8nO1xyXG5cclxudmFyIHRoZU1vZGUgPSB1bmRlZmluZWQ7XHJcblxyXG5leHBvcnQgZnVuY3Rpb24gSlNPTlBhcnNlKHRleHQ6IHN0cmluZyk6IGFueSB7XHJcbiAgICBmdW5jdGlvbiBjdXN0b21EZVNlcihrZXksIHZhbHVlKSB7XHJcbiAgICAgICAgaWYgKHZhbHVlLnRvU3RyaW5nKCkuaW5kZXhPZihcIl9fUkVHRVhQIFwiKSA9PSAwKSB7XHJcbiAgICAgICAgICAgIHZhciBtID0gdmFsdWUuc3BsaXQoXCJfX1JFR0VYUCBcIilbMV0ubWF0Y2goL1xcLyguKilcXC8oLiopPy8pO1xyXG4gICAgICAgICAgICByZXR1cm4gbmV3IFJlZ0V4cChtWzFdLCBtWzJdIHx8IFwiXCIpO1xyXG4gICAgICAgIH0gZWxzZVxyXG4gICAgICAgICAgICByZXR1cm4gdmFsdWU7XHJcbiAgICB9XHJcbiAgICByZXR1cm4gSlNPTi5wYXJzZSh0ZXh0LCBjdXN0b21EZVNlcik7XHJcbn1cclxuXHJcblxyXG5cclxuZXhwb3J0IGZ1bmN0aW9uIEpTT05TdHJpbmdpZnkob2JqOiBhbnkpOiBzdHJpbmcge1xyXG4gICAgZnVuY3Rpb24gY3VzdG9tU2VyKGtleSwgdmFsdWUpIHtcclxuICAgICAgICBpZiAodmFsdWUgaW5zdGFuY2VvZiBSZWdFeHApe1xyXG4gICAgICAgICAgICByZXR1cm4gKFwiX19SRUdFWFAgXCIgKyB2YWx1ZS50b1N0cmluZygpKTtcclxuICAgICAgICB9XHJcbiAgICAgICAgZWxzZVxyXG4gICAgICAgICAgICByZXR1cm4gdmFsdWU7XHJcbiAgICB9XHJcbiAgICByZXR1cm4gSlNPTi5zdHJpbmdpZnkob2JqLCBjdXN0b21TZXIsIDIpO1xyXG59XHJcblxyXG5mdW5jdGlvbiByZWFkRmlsZUFzSlNPTihmaWxlbmFtZTogc3RyaW5nKTogYW55IHtcclxuICAgIHZhciBkYXRhID0gZnMucmVhZEZpbGVTeW5jKGZpbGVuYW1lLCAndXRmLTgnKTtcclxuICAgIHRyeSB7XHJcbiAgICAgICAgcmV0dXJuIEpTT04ucGFyc2UoZGF0YSk7XHJcbiAgICB9IGNhdGNoIChlKSB7XHJcbiAgICAgICAgY29uc29sZS5sb2coXCJDb250ZW50IG9mIGZpbGUgXCIgKyBmaWxlbmFtZSArIFwiIGlzIG5vIGpzb25cIiArIGUpO1xyXG4gICAgICAgIHByb2Nlc3MuZXhpdCgtMSk7XHJcbiAgICB9XHJcbiAgICByZXR1cm4gdW5kZWZpbmVkO1xyXG59XHJcblxyXG5cclxuZnVuY3Rpb24gYXNzdXJlUGF0aChwYXRoOiBzdHJpbmcpIHtcclxuICAgIHRyeSB7XHJcbiAgICAgICAgZnMubWtkaXJTeW5jKHBhdGgpO1xyXG4gICAgfSBjYXRjaCAoZSkge1xyXG5cclxuICAgIH1cclxuICAgIHRyeSB7XHJcbiAgICAgICAgZnMubWtkaXJTeW5jKHBhdGggKyAnZGF0YScpO1xyXG4gICAgfSBjYXRjaCAoZSkge1xyXG5cclxuICAgIH1cclxufVxyXG5cclxudmFyIGRiRW1pdHRlciA9IG5ldyBldmVudHMuRXZlbnRFbWl0dGVyKCk7XHJcbi8vIHVuaXQgdGVzdCBpbnZva2UgdGhpcyBtdWx0aXBsZSB0aW1lcywgYXZvaWQgbm9kZSBqcyB3YXJuaW5nXHJcbmRiRW1pdHRlci5zZXRNYXhMaXN0ZW5lcnMoMCk7XHJcblxyXG5leHBvcnQgZnVuY3Rpb24gaW5zdHJ1bWVudE1vZGVsKG1vZGVsOiBtb25nb29zZS5Nb2RlbDxhbnk+KSB7XHJcbiAgICBpZiAodGhlTW9kZSA9PT0gXCJSRUNPUkRcIikge1xyXG4gICAgICAgIGluc3RydW1lbnRNb2RlbFJlY29yZChtb2RlbCk7XHJcbiAgICB9IGVsc2UgaWYgKHRoZU1vZGUgPT09IFwiUkVQTEFZXCIpIHtcclxuICAgICAgICAvLyB0b2RvXHJcbiAgICAgICAgaW5zdHJ1bWVudE1vZGVsUmVwbGF5KG1vZGVsKTtcclxuICAgIH1cclxuICAgIHJldHVybiBtb2RlbDtcclxufVxyXG5cclxuXHJcbmZ1bmN0aW9uIG1ha2VGaWxlTmFtZShkaWdlc3QpIHtcclxuICAgIHJldHVybiAocmVjb3JkaW5nUGF0aCArICdkYXRhLycgKyBkaWdlc3QgKyAnLmpzb24nKTtcclxufVxyXG5cclxuZXhwb3J0IGZ1bmN0aW9uIGRpZ2VzdEFyZ3Mob3A6IHN0cmluZywgbmFtZSA6IHN0cmluZywgcXVlcnkgOiBhbnkpIHtcclxuICAgIHZhciBtZDVzdW0gPSBjcnlwdG8uY3JlYXRlSGFzaCgnbWQ1Jyk7XHJcbiAgICBkZWJ1Z2xvZygnaGVyZSB0aGUgbmFtZSAnICsgbmFtZSk7XHJcbiAgICBtZDVzdW0udXBkYXRlKG9wICsgbmFtZSArIEpTT05TdHJpbmdpZnkocXVlcnkpKTtcclxuICAgIHZhciBkaWdlc3QgPSAnJyArIG1kNXN1bS5kaWdlc3QoJ2hleCcpO1xyXG4gICAgcmV0dXJuIGRpZ2VzdDtcclxufVxyXG5cclxuZXhwb3J0IGZ1bmN0aW9uIHJlY29yZE9wKG9wOiBzdHJpbmcsIG5hbWU6IHN0cmluZywgcXVlcnk6IGFueSwgcmVzOiBhbnkpIHtcclxuICAgIHZhciBkaWdlc3QgPSBkaWdlc3RBcmdzKG9wLG5hbWUscXVlcnkpO1xyXG4gICAgdmFyIHJlc1N0ciA9IEpTT04uc3RyaW5naWZ5KHJlcywgdW5kZWZpbmVkLCAyKTtcclxuICAgIHZhciBsZW4gPSAwO1xyXG4gICAgaWYocmVzICYmIEFycmF5LmlzQXJyYXkocmVzKSkge1xyXG4gICAgICAgIGxlbiA9IHJlcy5sZW5ndGg7XHJcbiAgICB9IGVsc2Uge1xyXG4gICAgICAgIGxlbiA9IHJlc1N0ci5sZW5ndGg7XHJcbiAgICB9XHJcbiAgICB2YXIgZmlsZW5hbWUgPSBtYWtlRmlsZU5hbWUoZGlnZXN0KTtcclxuICAgIGNvbnNvbGUubG9nKCAncmVjb3JkaW5nIHRvIGZpbGU6ICcgKyBmaWxlbmFtZSArICcgKCcgKyBwYXRoLm5vcm1hbGl6ZShmaWxlbmFtZSkgKyAnKS4uLicpO1xyXG4gICAgZnMud3JpdGVGaWxlU3luYyhmaWxlbmFtZSwgcmVzU3RyKTtcclxuICAgIHZhciBrbm93biA9IHt9O1xyXG4gICAgdHJ5IHtcclxuICAgICAgICBrbm93biA9IHJlYWRGaWxlQXNKU09OKHJlY29yZGluZ1BhdGggKyAncXVlcmllcy5qc29uJyk7XHJcbiAgICB9IGNhdGNoIChleCkge1xyXG5cclxuICAgIH1cclxuICAgIGtub3duW2RpZ2VzdF0gPSB7XHJcbiAgICAgICAgb3A6IG9wLFxyXG4gICAgICAgIG5hbWU6IG5hbWUsXHJcbiAgICAgICAgZGlnZXN0OiBkaWdlc3QsXHJcbiAgICAgICAgcXVlcnk6IHF1ZXJ5LFxyXG4gICAgICAgIHJlcyA6IGxlblxyXG4gICAgfTtcclxuICAgIGZzLndyaXRlRmlsZVN5bmMocmVjb3JkaW5nUGF0aCArICdxdWVyaWVzLmpzb24nLCBKU09OU3RyaW5naWZ5KGtub3duKSk7XHJcbn1cclxuXHJcbmV4cG9ydCBmdW5jdGlvbiByZXRyaWV2ZU9wKG9wOiBzdHJpbmcsIG5hbWU6IHN0cmluZywgcXVlcnk6IGFueSkge1xyXG4gICAgdmFyIGRpZ2VzdCA9IGRpZ2VzdEFyZ3Mob3AsbmFtZSwgcXVlcnkpO1xyXG4gICAgdmFyIGZpbGVuYW1lID0gbWFrZUZpbGVOYW1lKGRpZ2VzdCk7XHJcbiAgICBkZWJ1Z2xvZygnIHJlYWRpbmcgZnJvbSBmaWxlbmFtZSAnICsgZmlsZW5hbWUpO1xyXG4gICAgdHJ5IHtcclxuICAgICAgICB2YXIgcmVzID0gcmVhZEZpbGVBc0pTT04oZmlsZW5hbWUpO1xyXG4gICAgfSBjYXRjaChlKSB7XHJcbiAgICAgICAgY29uc29sZS5sb2coZSk7XHJcbiAgICAgICAgY29uc29sZS5sb2coZS5zdGFjayk7XHJcbiAgICAgICAgY29uc29sZS5sb2coYGRpZCBub3QgZmluZCBxdWVyeSByZXN1bHQgcmVjb3JkaW5nICgke2ZpbGVuYW1lfSkgXFxuIGZvciBjb2xsZWN0aW9uICR7bmFtZX0gb3BlcmF0aW9uICR7b3B9IFxcbiBxdWVyeSBhcmd1bWVudHM6IGAgKyBKU09OU3RyaW5naWZ5KHF1ZXJ5KSk7XHJcbiAgICAgICAgdGhyb3cgZTtcclxuICAgIH1cclxuICAgIGlmIChyZXMgPT09IHVuZGVmaW5lZCkge1xyXG4gICAgICAgIGRlYnVnbG9nKCdlbXB0eSByZXN1bHQgZm9yIHF1ZXJ5ICcgKyBvcCArICcgJyArIEpTT04uc3RyaW5naWZ5KHF1ZXJ5LCB1bmRlZmluZWQsIDIpICsgJ1xcbicgKyBmaWxlbmFtZSk7XHJcbiAgICB9XHJcbiAgICByZXR1cm4gcmVzO1xyXG59XHJcblxyXG5leHBvcnQgZnVuY3Rpb24gaW5zdHJ1bWVudE1vZGVsUmVjb3JkKG1vZGVsRG9jOiBtb25nb29zZS5Nb2RlbDxhbnk+KSB7XHJcbiAgICBjb25zb2xlLmxvZygnbW9uZ29vc2VfcmVjb3JkX3JlcGxheSBpcyBpbnN0cnVtZW50aW5nIG1vZGVsICcgKyBtb2RlbERvYy5tb2RlbE5hbWUgKyAnIGZvciByZWNvcmRpbmcgdG8gJyArIHJlY29yZGluZ1BhdGggKTtcclxuICAgIHZhciBvRmluZCA9IG1vZGVsRG9jLmZpbmQ7XHJcbiAgICBtb2RlbERvYy5maW5kID0gZnVuY3Rpb24gKCk6IGFueSB7XHJcbiAgICAgICAgZGVidWdsb2coJ3NvbWVvbmUgaXMgY2FsbGluZyBmaW5kIHdpdGggJyArIG1vZGVsRG9jLm1vZGVsTmFtZSArIEpTT04uc3RyaW5naWZ5KGFyZ3VtZW50cywgdW5kZWZpbmVkLCAyKSk7XHJcbiAgICAgICAgdmFyIHJlcyA9IG9GaW5kLmFwcGx5KG1vZGVsRG9jLCBhcmd1bWVudHMpO1xyXG4gICAgICAgIGlmIChhcmd1bWVudHMubGVuZ3RoICE9PSAxKSB7XHJcbiAgICAgICAgICAgIHRocm93IEVycm9yKCdleHBlY3RlZCBvbmUgYXJndW1lbnQgaW4gZmluZCwgd2FzICcgKyBhcmd1bWVudHMubGVuZ3RoKTtcclxuICAgICAgICB9XHJcbiAgICAgICAgdmFyIHF1ZXJ5ID0gYXJndW1lbnRzWzBdO1xyXG4gICAgICAgIHJlcy5sZWFuKCkuZXhlYygpLnRoZW4oKGEpID0+IHtcclxuICAgICAgICAgICAgLy9jb25zb2xlLmxvZyhcImhlcmUgcmVzdWx0MSArIFwiICsgSlNPTi5zdHJpbmdpZnkoYSwgdW5kZWZpbmVkLDIpICk7XHJcbiAgICAgICAgICAgIHJlY29yZE9wKFwiZmluZFwiLCBtb2RlbERvYy5tb2RlbE5hbWUsIHF1ZXJ5LCBhKTtcclxuICAgICAgICB9XHJcbiAgICAgICAgKTtcclxuICAgICAgICByZXR1cm4gcmVzO1xyXG4gICAgfVxyXG4gICAgdmFyIG9EaXN0aW5jdCA9IG1vZGVsRG9jLmRpc3RpbmN0O1xyXG4gICAgbW9kZWxEb2MuZGlzdGluY3QgPSBmdW5jdGlvbiAoKTogYW55IHtcclxuICAgICAgICBkZWJ1Z2xvZygnc29tZW9uZSBpcyBjYWxsaW5nIGRpc3RpbmN0IHdpdGgnICsgSlNPTi5zdHJpbmdpZnkoYXJndW1lbnRzLCB1bmRlZmluZWQsIDIpKTtcclxuICAgICAgICB2YXIgcmVzID0gb0Rpc3RpbmN0LmFwcGx5KG1vZGVsRG9jLCBhcmd1bWVudHMpO1xyXG4gICAgICAgIGlmIChhcmd1bWVudHMubGVuZ3RoICE9PSAxKSB7XHJcbiAgICAgICAgICAgIHRocm93IEVycm9yKCdleHBlY3RlZCBvbmUgYXJndW1lbnQgJyArIEpTT04uc3RyaW5naWZ5KGFyZ3VtZW50cykpO1xyXG4gICAgICAgIH1cclxuICAgICAgICB2YXIgcXVlcnkgPSBhcmd1bWVudHNbMF07XHJcbiAgICAgICAgdmFyIHJlczIgPSByZXMudGhlbigoYSkgPT4ge1xyXG4gICAgICAgICAgICBkZWJ1Z2xvZyggKCkgPT4gXCJoZXJlIHJlc3VsdDEgKyBcIiArIEpTT04uc3RyaW5naWZ5KGEsIHVuZGVmaW5lZCwyKSApO1xyXG4gICAgICAgICAgICB0cnkge1xyXG4gICAgICAgICAgICAgICAgcmVjb3JkT3AoXCJkaXN0aW5jdFwiLCBtb2RlbERvYy5tb2RlbE5hbWUsIHF1ZXJ5LCBhKTtcclxuICAgICAgICAgICAgfSBjYXRjaCggZXgpXHJcbiAgICAgICAgICAgIHtcclxuICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKCAnIHJlY29yZGluZyB0byBmaWxlIGZhaWxlZCAnICsgZXggKTtcclxuICAgICAgICAgICAgICAgIGRlYnVnbG9nKCAoKSA9PiBcIiByZWNvcmRpbmcgdG8gZmlsZSBmYWlsZWQgXCIgKyBleCApO1xyXG4gICAgICAgICAgICAgICAgdGhyb3cgZXg7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgcmV0dXJuIGE7XHJcbiAgICAgICAgfVxyXG4gICAgICAgICk7XHJcbiAgICAgICAgcmV0dXJuIHJlczsgLy9yZXMyLnRoZW4oKGIpID0+IHsgY29uc29sZS5sb2coJyAybmQgcHJvbWlzZSB0aGVuICcgKyBiICYmIGIubGVuZ3RoKTsgcmV0dXJuIGI7IH0pO1xyXG4gICAgfVxyXG4gICAgdmFyIG9BZ2dyZWdhdGUgPSBtb2RlbERvYy5hZ2dyZWdhdGU7XHJcbiAgICBtb2RlbERvYy5hZ2dyZWdhdGUgPSBmdW5jdGlvbiAoKTogYW55IHtcclxuICAgICAgICBkZWJ1Z2xvZygoKSA9PiAnc29tZW9uZSBpcyBjYWxsaW5nIGFnZ3JlZ2F0ZSB3aXRoJyArIEpTT04uc3RyaW5naWZ5KGFyZ3VtZW50cywgdW5kZWZpbmVkLCAyKSk7XHJcbiAgICAgICAgdmFyIHF1ZXJ5ID0gQXJyYXkucHJvdG90eXBlLnNsaWNlLmNhbGwoYXJndW1lbnRzKTtcclxuICAgICAgICB2YXIgcmVzID0gb0FnZ3JlZ2F0ZS5hcHBseShtb2RlbERvYywgYXJndW1lbnRzKTtcclxuICAgICAgICByZXMudGhlbigoYSkgPT4ge1xyXG4gICAgICAgICAgICBkZWJ1Z2xvZygoKSA9PiBcImhlcmUgcmVzdWx0MSArIFwiICsgSlNPTi5zdHJpbmdpZnkoYSwgdW5kZWZpbmVkLCAyKSk7XHJcbiAgICAgICAgICAgIHJlY29yZE9wKFwiYWdncmVnYXRlXCIsIG1vZGVsRG9jLm1vZGVsTmFtZSwgcXVlcnksIGEpO1xyXG4gICAgICAgIH1cclxuICAgICAgICApO1xyXG4gICAgICAgIHJldHVybiByZXM7XHJcbiAgICB9XHJcbn1cclxuXHJcbmV4cG9ydCBmdW5jdGlvbiBpbnN0cnVtZW50TW9kZWxSZXBsYXkobW9kZWxEb2M6IG1vbmdvb3NlLk1vZGVsPGFueT4pIHtcclxuICAgIGNvbnNvbGUubG9nKCdpbnN0cnVtZW50aW5nIG1vZGVsICcgKyBtb2RlbERvYy5tb2RlbE5hbWUgKyAnIGZvciByZXBsYXkgZnJvbSBwYXRoICcgKyByZWNvcmRpbmdQYXRoICk7XHJcbiAgICBkZWJ1Z2xvZygnaW5zdHJ1bWVudGluZyBtb2RlbCAnICsgbW9kZWxEb2MubW9kZWxOYW1lKTtcclxuICAgIHZhciBvRmluZCA9IG1vZGVsRG9jLmZpbmQ7XHJcbiAgICBtb2RlbERvYy5maW5kID0gZnVuY3Rpb24gKCk6IGFueSB7XHJcbiAgICAgICAgZGVidWdsb2coKCkgPT4gJ3NvbWVvbmUgaXMgcmVwbGF5aW5nIGZpbmQgd2l0aCcgKyBKU09OLnN0cmluZ2lmeShhcmd1bWVudHMsIHVuZGVmaW5lZCwgMikpO1xyXG4gICAgICAgIHZhciBxdWVyeSA9IGFyZ3VtZW50c1swXTtcclxuICAgICAgICB2YXIgcmVzID0gcmV0cmlldmVPcChcImZpbmRcIiwgbW9kZWxEb2MubW9kZWxOYW1lLCBxdWVyeSk7XHJcbiAgICAgICAgZGVidWdsb2coKCkgPT4gJ3JldHVybmluZyByZXMgJyArIEpTT04uc3RyaW5naWZ5KHJlcykgKyAnIGZvciBxdWVyeSBmaW5kJyArIHF1ZXJ5KTtcclxuICAgICAgICByZXR1cm4ge1xyXG4gICAgICAgICAgICBsZWFuOiBmdW5jdGlvbiAoKSB7XHJcbiAgICAgICAgICAgICAgICByZXR1cm4ge1xyXG4gICAgICAgICAgICAgICAgICAgIGV4ZWM6IGZ1bmN0aW9uICgpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIG5ldyBQcm9taXNlKGZ1bmN0aW9uIChyZXNvbHZlLCByZWplY3QpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNldFRpbWVvdXQoZnVuY3Rpb24gKCkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJlc29sdmUocmVzKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0sIDApO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB9KTtcclxuICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9XHJcbiAgICB9XHJcbiAgICB2YXIgb0Rpc3RpbmN0ID0gbW9kZWxEb2MuZGlzdGluY3Q7XHJcbiAgICBtb2RlbERvYy5kaXN0aW5jdCA9IGZ1bmN0aW9uICgpOiBhbnkge1xyXG4gICAgICAgIGRlYnVnbG9nKCdzb21lb25lIGlzIHJlcGxheWluZyBkaXN0aW5jdCB3aXRoJyArIEpTT04uc3RyaW5naWZ5KGFyZ3VtZW50cywgdW5kZWZpbmVkLCAyKSk7XHJcbiAgICAgICAgdmFyIHF1ZXJ5ID0gYXJndW1lbnRzWzBdO1xyXG4gICAgICAgIHZhciByZXMgPSByZXRyaWV2ZU9wKFwiZGlzdGluY3RcIiwgbW9kZWxEb2MubW9kZWxOYW1lLCBxdWVyeSk7XHJcbiAgICAgICAgZGVidWdsb2coJ3JldHVybmluZyByZXMgJyArIEpTT04uc3RyaW5naWZ5KHJlcykgKyAnIGZvciBxdWVyeSBmaW5kJyArIHF1ZXJ5KTtcclxuICAgICAgICByZXR1cm4gbmV3IFByb21pc2UoZnVuY3Rpb24gKHJlc29sdmUsIHJlamVjdCkge1xyXG4gICAgICAgICAgICBzZXRUaW1lb3V0KGZ1bmN0aW9uICgpIHsgcmVzb2x2ZShyZXMpOyB9LCAwKTtcclxuICAgICAgICB9KTtcclxuICAgIH1cclxuICAgIHZhciBvQWdncmVnYXRlID0gbW9kZWxEb2MuYWdncmVnYXRlO1xyXG4gICAgbW9kZWxEb2MuYWdncmVnYXRlID0gZnVuY3Rpb24gKCk6IGFueSB7XHJcbiAgICAgICAgZGVidWdsb2coJ3NvbWVvbmUgaXMgcmVwbGF5aW5nIGFnZ3JlZ2F0ZSB3aXRoJyArIEpTT04uc3RyaW5naWZ5KGFyZ3VtZW50cywgdW5kZWZpbmVkLCAyKSk7XHJcbiAgICAgICAgdmFyIHF1ZXJ5ID0gQXJyYXkucHJvdG90eXBlLnNsaWNlLmNhbGwoYXJndW1lbnRzKTtcclxuICAgICAgICB2YXIgcmVzID0gcmV0cmlldmVPcChcImFnZ3JlZ2F0ZVwiLCBtb2RlbERvYy5tb2RlbE5hbWUsIHF1ZXJ5KTtcclxuICAgICAgICB2YXIgcCA9IG5ldyBQcm9taXNlKGZ1bmN0aW9uIChyZXNvbHZlLCByZWplY3QpIHtcclxuICAgICAgICAgICAgc2V0VGltZW91dChmdW5jdGlvbiAoKSB7IHJlc29sdmUocmVzKTsgfSwgMCk7XHJcbiAgICAgICAgfSk7XHJcbiAgICAgICAgKHAgYXMgYW55KS5leGVjID0gZnVuY3Rpb24gKCkge1xyXG4gICAgICAgICAgICByZXR1cm4gcDtcclxuICAgICAgICB9XHJcbiAgICAgICAgcmV0dXJuIHA7XHJcbiAgICB9XHJcbn1cclxuXHJcbi8qKlxyXG4gKiBmdW50aW9uIHRvIGluc3RydW1lbnQgbW9uZ29vc2VcclxuICpcclxuICpcclxuICpcclxuICogQHBhcmFtIG1vbmdvb3NlIGEgcmVhbCBtb25nb29zZSBpbnN0YW5jZVxyXG4gKiBAcGFyYW0gW3BhdGhdIHtzdHJpbmd9IG9wdGlvbmFsLCBhIHBhdGggdG8gd3JpdGUvcmVhZCBmaWxlcyBmcm9tLCBkZWZhdWx0cyB0byBcIm1ncmVjcmVwL1wiXHJcbiAqIEBwYXJhbSBtb2RlIHtzdHJpbmd9ICB1bmRlZmluZWQgKGVudmlyb25tZW50IHZhbHVlKSBvciBcIlJFUExBWVwiIG9yIFwiUkVDT1JEXCJcclxuICovXHJcbmV4cG9ydCBmdW5jdGlvbiBpbnN0cnVtZW50TW9uZ29vc2UobW9uZ29vc2U6IG1vbmdvb3NlLk1vbmdvb3NlLCBwYXRoPzogc3RyaW5nLCBtb2RlPzogc3RyaW5nKTogbW9uZ29vc2UuTW9uZ29vc2Uge1xyXG4gICAgdGhlTW9kZSA9IG1vZGUgfHwgcHJvY2Vzcy5lbnYuTU9OR09fUkVDT1JEX1JFUExBWTtcclxuICAgIGlmICh0aGVNb2RlICYmIFtcIlJFUExBWVwiLCBcIlJFQ09SRFwiXS5pbmRleE9mKG1vZGUpIDwgMCkge1xyXG4gICAgICAgIGNvbnNvbGUubG9nKCdwYXNzZWQgbW9kZSB2YWx1ZSBvciBlbnYgTU9OR09fUkVDT1JEX1JFUExBWSBtYXkgb25seSBiZSBcIlJFQ09SRFwiIG9yIFwiUkVQTEFZXCIgLCBNT05HT19SRUNPUkQgTU9OR09fUkVQTEFZJyk7XHJcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdtb25nb29zZV9yZWNvcmRfcmVwbGF5IG1vZGUgc2hvdWxkIGJlIG9uZSBvZiBcIlJFUExBWVwiLCBcIlJFQ09SRFwiICB3YXMgJyArIHRoZU1vZGUpO1xyXG4gICAgfVxyXG4gICAgaWYgKHRoZU1vZGUgPT09IFwiUkVDT1JEXCIpIHtcclxuICAgICAgICByZWNvcmRpbmdQYXRoID0gcGF0aCB8fCBwcm9jZXNzLmVudi5NT05HT19SRUNPUkRfUkVQTEFZX1BBVEggfHwgXCJtb25nb29zZV9yZWNvcmRfcmVwbGF5XCI7XHJcbiAgICAgICAgY29uc29sZS5sb2coICchKiBtb2RlIFJFQ09SRCB0byBwYXRoICcgKyByZWNvcmRpbmdQYXRoICk7XHJcbiAgICAgICAgYXNzdXJlUGF0aChyZWNvcmRpbmdQYXRoKTtcclxuICAgICAgICB2YXIgb21vZGVsID0gbW9uZ29vc2UubW9kZWw7XHJcbiAgICAgICAgbW9uZ29vc2UubW9kZWwgPSBmdW5jdGlvbiAoKSB7XHJcbiAgICAgICAgICAgIGlmIChhcmd1bWVudHMubGVuZ3RoID4gMSkge1xyXG4gICAgICAgICAgICAgICAgcmV0dXJuIGluc3RydW1lbnRNb2RlbChvbW9kZWwuYXBwbHkobW9uZ29vc2UsIGFyZ3VtZW50cykpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIHJldHVybiBvbW9kZWwuYXBwbHkobW9uZ29vc2UsIGFyZ3VtZW50cyk7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHJldHVybiBtb25nb29zZTtcclxuICAgIH0gZWxzZSBpZiAodGhlTW9kZSA9PT0gXCJSRVBMQVlcIikge1xyXG4gICAgICAgIGNvbnNvbGUubG9nKCAnISogbW9kZSBSRVBMQVkgZnJvbSBwYXRoICcgKyByZWNvcmRpbmdQYXRoICk7XHJcbiAgICAgICAgcmVjb3JkaW5nUGF0aCA9IHBhdGggfHwgcHJvY2Vzcy5lbnYuTU9OR09fUkVDT1JEX1JFUExBWV9QQVRIIHx8IFwibW9uZ29vc2VfcmVjb3JkX3JlcGxheVwiO1xyXG4gICAgICAgIHJldHVybiBtb25nb29zZU1vY2sgYXMgYW55O1xyXG4gICAgfVxyXG4gICAgcmV0dXJuIG1vbmdvb3NlO1xyXG59XHJcblxyXG5cclxuZXhwb3J0IHZhciBtb25nb29zZU1vY2sgPSB7XHJcbiAgICBtb2RlbHM6IHt9LFxyXG4gICAgbW9kZWxOYW1lczogZnVuY3Rpb24gKCkge1xyXG4gICAgICAgIHJldHVybiBPYmplY3Qua2V5cyh0aGlzLm1vZGVscyk7XHJcbiAgICB9LFxyXG4gICAgU2NoZW1hOiBtb25nb29zZS5TY2hlbWEsXHJcblxyXG4gICAgbW9kZWw6IGZ1bmN0aW9uIChhLCBiKSB7XHJcbiAgICAgICAgaWYgKGIgPT09IHVuZGVmaW5lZCkge1xyXG4gICAgICAgICAgICByZXR1cm4gdGhpcy5tb2RlbHNbYV07XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGRlYnVnbG9nKCdjcmVhdGluZyBtb2RlbCAgJyArIGEgKyAnIGF0IG1vY2snKTtcclxuICAgICAgICB0aGlzLm1vZGVsc1thXSA9IGluc3RydW1lbnRNb2RlbCh7XHJcbiAgICAgICAgICAgIGZpbmQ6IGZ1bmN0aW9uICgpIHsgfSxcclxuICAgICAgICAgICAgYWdncmVnYXRlOiBmdW5jdGlvbiAoKSB7IH0sXHJcbiAgICAgICAgICAgIGRpc3RpbmN0OiBmdW5jdGlvbiAoKSB7IH0sXHJcbiAgICAgICAgICAgIG1vZGVsTmFtZTogYSxcclxuICAgICAgICAgICAgc2NoZW1hOiBiLFxyXG4gICAgICAgIH0gYXMgYW55KTtcclxuICAgICAgICByZXR1cm4gdGhpcy5tb2RlbHNbYV07XHJcbiAgICB9LFxyXG4gICAgZGlzY29ubmVjdDogZnVuY3Rpb24gKCkge1xyXG4gICAgICAgIGRlYnVnbG9nKCdzaW11bGF0aW9uZyBkaXNjb25uZWN0ICcpO1xyXG4gICAgfSxcclxuICAgIGNvbm5lY3Q6IGZ1bmN0aW9uIChjb25uU3RyOiBzdHJpbmcpIHtcclxuICAgICAgICAvLyB0aGlzLmRiLm9uLmVtaXQoJ29uJyk7XHJcbiAgICAgICAgZGVidWdsb2coJ3NpbXVsYXRpb25nIGNvbm5lY3RpbmcgdG8gJyArIGNvbm5TdHIpO1xyXG4gICAgICAgIGlmICghdGhpcy5fb25jZSkge1xyXG4gICAgICAgICAgICB2YXIgdGhhdCA9IHRoaXM7XHJcbiAgICAgICAgICAgIHNldFRpbWVvdXQoZnVuY3Rpb24gKCkge1xyXG4gICAgICAgICAgICAgICAgdGhhdC5jb25uZWN0aW9uLmVtaXQoJ29wZW4nKTtcclxuICAgICAgICAgICAgICAgIGRlYnVnbG9nKCdmaXJlZCBlbWl0Jyk7XHJcbiAgICAgICAgICAgIH0sIDApO1xyXG4gICAgICAgIH1cclxuICAgIH0sXHJcbiAgICBjb25uZWN0aW9uOiBkYkVtaXR0ZXJcclxufTtcclxuIl19
